---
import { getCollection } from 'astro:content';
import { getLangFromUrl, getLocalizedPath } from '../i18n/utils';
import GettingStartedNav from './nav/GettingStartedNav.astro';
import DocsNav from './nav/DocsNav.astro';
import SectionNav from './nav/SectionNav.astro';

interface Props {
  currentPath: string;
}

const { currentPath } = Astro.props;
const currentLocale = getLangFromUrl(Astro.url);

// Detect section from URL
function getSectionFromUrl(path: string): string {
  // Remove language prefix if present (e.g., /vi/docs -> /docs)
  const cleanPath = path.replace(/^\/[a-z]{2}\//, '/');

  if (cleanPath === '/' || cleanPath === '') return 'home';
  if (cleanPath.startsWith('/docs/getting-started')) return 'getting-started';
  if (cleanPath.startsWith('/docs/engineer')) return 'engineer';
  if (cleanPath.startsWith('/docs/marketing')) return 'marketing';
  if (cleanPath.startsWith('/docs/cli')) return 'cli';
  if (cleanPath.startsWith('/docs/workflows')) return 'workflows';
  if (cleanPath.startsWith('/docs/tools')) return 'tools';
  if (cleanPath.startsWith('/docs/changelog')) return 'changelog';
  if (cleanPath.startsWith('/docs/support')) return 'support';
  return 'docs';
}

const section = getSectionFromUrl(currentPath);

// Get docs from appropriate collection based on locale
const collectionName = currentLocale === 'vi' ? 'docs-vi' : 'docs';
const allDocs = await getCollection(collectionName, (entry) => entry.data.published);

// Filter by section
const sectionDocs = allDocs.filter(doc => doc.data.section === section);
---

<nav class="sidebar-nav" aria-label="Documentation navigation">
  {section === 'home' && (
    <div class="landing-nav">
      <div class="landing-nav-section">
        <span class="nav-section-title landing-section-label">Quick Links</span>
        <ul class="nav-items">
          <li><a href={getLocalizedPath('/docs/getting-started/introduction', currentLocale)} class="nav-item">
            <svg class="file-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/></svg>
            Getting Started
          </a></li>
          <li><a href={getLocalizedPath('/docs/getting-started/installation', currentLocale)} class="nav-item">
            <svg class="file-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Installation
          </a></li>
          <li><a href={getLocalizedPath('/docs/getting-started/quick-start', currentLocale)} class="nav-item">
            <svg class="file-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            Quick Start
          </a></li>
        </ul>
      </div>
      <div class="landing-nav-section">
        <span class="nav-section-title landing-section-label">Products</span>
        <ul class="nav-items">
          <li><a href={getLocalizedPath('/docs/engineer/agents', currentLocale)} class="nav-item">
            <svg class="file-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
            Engineer Kit
          </a></li>
          <li><a href={getLocalizedPath('/docs/marketing/', currentLocale)} class="nav-item">
            <svg class="file-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
            Marketing Kit
          </a></li>
          <li><a href={getLocalizedPath('/docs/cli/', currentLocale)} class="nav-item">
            <svg class="file-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
            CLI Tool
          </a></li>
        </ul>
      </div>
      <div class="landing-nav-section">
        <span class="nav-section-title landing-section-label">Explore</span>
        <ul class="nav-items">
          <li><a href={getLocalizedPath('/docs/workflows/new-project', currentLocale)} class="nav-item">
            <svg class="file-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
            Workflows
          </a></li>
          <li><a href={getLocalizedPath('/docs/changelog', currentLocale)} class="nav-item">
            <svg class="file-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            Changelog
          </a></li>
          <li><a href={getLocalizedPath('/docs/support/troubleshooting', currentLocale)} class="nav-item">
            <svg class="file-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
            Support
          </a></li>
        </ul>
      </div>
    </div>
  )}
  {section === 'getting-started' && <GettingStartedNav docs={sectionDocs} currentPath={currentPath} />}
  {section === 'docs' && <DocsNav docs={sectionDocs} currentPath={currentPath} />}
  {['engineer', 'marketing', 'cli', 'workflows', 'tools', 'changelog', 'support'].includes(section) && (
    <SectionNav docs={sectionDocs} currentPath={currentPath} section={section} />
  )}
</nav>

<script>
  // State persistence logic (runs client-side)
  const COLLAPSE_KEY = 'claudekit-sidebar-collapse-state';

  function initSidebarState() {
    const saved = sessionStorage.getItem(COLLAPSE_KEY);
    const state = saved ? JSON.parse(saved) : {};

    // Apply saved collapse state
    document.querySelectorAll('[data-collapsible]').forEach(section => {
      const key = section.getAttribute('data-category');
      const isCollapsed = state[key] ?? true; // Default collapsed

      const button = section.querySelector('button');
      const items = section.querySelector('.nav-items');

      if (isCollapsed) {
        section.classList.add('collapsed');
        items?.setAttribute('hidden', '');
      } else {
        section.classList.remove('collapsed');
        items?.removeAttribute('hidden');
      }
    });

    // Add click handlers
    document.querySelectorAll('[data-collapsible] button').forEach(button => {
      button.addEventListener('click', (e) => {
        const section = button.closest('[data-collapsible]');
        const key = section.getAttribute('data-category');
        const items = section.querySelector('.nav-items');

        const isCollapsed = section.classList.toggle('collapsed');

        if (isCollapsed) {
          items?.setAttribute('hidden', '');
        } else {
          items?.removeAttribute('hidden');
        }

        // Save state
        const saved = sessionStorage.getItem(COLLAPSE_KEY);
        const state = saved ? JSON.parse(saved) : {};
        state[key] = isCollapsed;
        sessionStorage.setItem(COLLAPSE_KEY, JSON.stringify(state));
      });
    });
  }

  // Initialize on page load
  document.addEventListener('astro:page-load', initSidebarState);
  document.addEventListener('DOMContentLoaded', initSidebarState);
</script>


<style>
  /* Sidebar Navigation (Polar v1.1) */
  .sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .nav-section {
    display: flex;
    flex-direction: column;
  }

  /* Section Header (Polar v1.1: 12px uppercase, letter-spacing 0.05em) */
  .nav-section-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: transparent;
    border: none;
    color: var(--color-text-secondary);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    cursor: pointer;
    border-radius: var(--radius-md);
    transition: all var(--duration-normal) var(--ease-out);
    margin-bottom: var(--space-1);
  }

  .nav-section-title:hover {
    background-color: var(--color-bg-tertiary);
    color: var(--color-text-primary);
  }

  .chevron {
    transition: transform var(--duration-normal) var(--ease-out);
    color: var(--color-text-muted);
    width: var(--icon-sm);
    height: var(--icon-sm);
  }

  .nav-section.collapsed .chevron {
    transform: rotate(0deg);
  }

  .nav-section:not(.collapsed) .chevron {
    transform: rotate(90deg);
  }

  .folder-icon {
    color: var(--color-accent-blue);
    width: var(--icon-sm);
    height: var(--icon-sm);
  }

  .nav-items {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0;
    transition: all var(--duration-normal) var(--ease-out);
  }

  .nav-section.collapsed .nav-items {
    display: none;
  }

  /* Navigation Item (Polar v1.1: 14px font, active with 2px blue left border) */
  .nav-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    padding-left: calc(var(--space-3) + 32px);
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    text-decoration: none;
    border-radius: var(--radius-md);
    transition: all var(--duration-normal) var(--ease-out);
    position: relative;
  }

  .nav-item:hover {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    text-decoration: none;
  }

  /* Active State (Polar v1.1: 2px blue left border) */
  .nav-item.active {
    color: var(--color-text-primary);
    background: var(--color-bg-tertiary);
    font-weight: var(--font-normal);
    border-left: 2px solid var(--color-accent-blue);
    padding-left: calc(var(--space-3) + 30px);
  }

  .file-icon {
    color: var(--color-text-muted);
    width: var(--icon-sm);
    height: var(--icon-sm);
    flex-shrink: 0;
  }

  .nav-item.active .file-icon {
    color: var(--color-accent-blue);
  }

  /* Nested navigation (Polar v1.1) */
  .nav-nested {
    margin-inline-start: var(--space-4);
    padding-inline-start: var(--space-3);
    border-inline-start: 1px solid var(--color-border);
  }

  /* External link indicator (Polar v1.1) */
  .nav-item[data-external]::after {
    content: 'â†—';
    margin-inline-start: auto;
    font-size: var(--text-xs);
    opacity: 0.5;
  }

  /* Landing page sidebar nav */
  .landing-nav {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .landing-nav-section {
    display: flex;
    flex-direction: column;
  }

  .landing-section-label {
    cursor: default;
    padding: var(--space-2) var(--space-3);
  }

  .landing-section-label:hover {
    background: transparent;
  }

  .landing-nav .nav-item {
    padding-left: var(--space-3);
  }
</style>
