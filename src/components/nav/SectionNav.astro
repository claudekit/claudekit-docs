---
// Unified data-driven navigation component
// Replaces: EngineerNav, MarketingNav, CLINav, WorkflowsNav, ToolsNav, SupportNav, ChangelogNav

import { getLangFromUrl, getDocPath } from '../../i18n/utils';
import { NAV_SECTION_CONFIGS } from '../../lib/sidebar-nav-section-config';

interface Props {
  docs: any[];
  currentPath: string;
  section: string; // key into NAV_SECTION_CONFIGS
}

const { docs, currentPath, section } = Astro.props;
const currentLocale = getLangFromUrl(Astro.url);
const config = NAV_SECTION_CONFIGS[section];

if (!config) {
  throw new Error(`Unknown nav section: ${section}`);
}

// Helper to capitalize words
const capitalize = (str: string) => {
  return str.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
};

// Sort items by order
const sortItems = (items: any[]) => {
  return items.sort((a, b) => (a.data.order || 999) - (b.data.order || 999));
};

// Filter docs if needed
let filteredDocs = docs;
if (config.filterIndex) {
  filteredDocs = docs.filter(doc => !doc.slug.endsWith('index') && doc.slug !== section);
}

// Group docs by category for categorized/grouped layouts
const groupByCategory = (docs: any[]) => {
  const groups: Record<string, any[]> = {};
  docs.forEach(doc => {
    const category = doc.data.category || 'overview';
    if (!groups[category]) groups[category] = [];
    groups[category].push(doc);
  });
  return groups;
};

const categories = (config.layout === 'categorized' || config.layout === 'grouped')
  ? groupByCategory(filteredDocs)
  : {};
---

<div class="section-nav" style={`--section-accent: ${config.accentColor}`}>
  {config.badge && (
    <div class="nav-header">
      <span class:list={['nav-kit-badge', config.badgeStyle]}>
        {config.badgeIcon && (
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" set:html={config.badgeIcon} />
        )}
        {config.badge}
      </span>
    </div>
  )}

  {config.layout === 'categorized' && config.categoryOrder && (
    <>
      {config.categoryOrder.map(categoryKey => {
        const items = categories[categoryKey];
        if (!items || items.length === 0) return null;

        return (
          <div class="nav-section" data-category={categoryKey} data-collapsible>
            <button class="nav-section-title" aria-expanded="false">
              <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m9 18 6-6-6-6"></path>
              </svg>
              {config.categoryIcons && config.categoryIcons[categoryKey] && (
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="category-icon" set:html={config.categoryIcons[categoryKey]} />
              )}
              {capitalize(categoryKey)}
              <span class="item-count">({items.length})</span>
            </button>

            <div class="nav-items" hidden>
              {sortItems(items).map(doc => {
                const href = getDocPath(doc.slug, currentLocale);
                const isActive = currentPath === href || currentPath === href + '/';
                return (
                  <a href={href} class:list={['nav-link', { active: isActive }]}>
                    <span>{doc.data.title}</span>
                  </a>
                );
              })}
            </div>
          </div>
        );
      })}

      {/* Render orphan categories not in categoryOrder */}
      {(() => {
        const knownCategories = new Set(config.categoryOrder || []);
        const orphanCategories = Object.keys(categories).filter(k => !knownCategories.has(k));

        return orphanCategories.map(categoryKey => {
          const items = categories[categoryKey];
          if (!items || items.length === 0) return null;

          // Use default overview icon for orphans
          const defaultIcon = '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>';

          return (
            <div class="nav-section" data-category={categoryKey} data-collapsible>
              <button class="nav-section-title" aria-expanded="false">
                <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m9 18 6-6-6-6"></path>
                </svg>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="category-icon" set:html={defaultIcon} />
                {capitalize(categoryKey)}
                <span class="item-count">({items.length})</span>
              </button>

              <div class="nav-items" hidden>
                {sortItems(items).map(doc => {
                  const href = getDocPath(doc.slug, currentLocale);
                  const isActive = currentPath === href || currentPath === href + '/';
                  return (
                    <a href={href} class:list={['nav-link', { active: isActive }]}>
                      <span>{doc.data.title}</span>
                    </a>
                  );
                })}
              </div>
            </div>
          );
        });
      })()}
    </>
  )}

  {config.layout === 'flat' && (
    <div class="nav-section">
      <div class="nav-items">
        {sortItems(filteredDocs).map(doc => {
          const href = getDocPath(doc.slug, currentLocale);
          const isActive = currentPath === href || currentPath === href + '/';
          return (
            <a href={href} class:list={['nav-link', { active: isActive }]}>
              {config.showDocIcon && (
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="doc-icon">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
              )}
              <span>{doc.data.title}</span>
            </a>
          );
        })}
      </div>
    </div>
  )}

  {config.layout === 'grouped' && config.categoryMeta && (
    <>
      {Object.entries(categories).map(([category, categoryDocs]) => {
        const meta = config.categoryMeta![category] || { title: capitalize(category), collapsible: false };

        return (
          <div class="nav-section">
            <div class="nav-section-title">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="folder-icon"
              >
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              {meta.title}
            </div>

            <ul class="nav-items">
              {sortItems(categoryDocs).map(doc => {
                const href = getDocPath(doc.slug, currentLocale);
                const isActive = currentPath === href || currentPath === href + '/';

                return (
                  <li>
                    <a
                      href={href}
                      class:list={['nav-link', { active: isActive }]}
                    >
                      <span>{doc.data.title}</span>
                    </a>
                  </li>
                );
              })}
            </ul>
          </div>
        );
      })}
    </>
  )}
</div>

<style>
  .section-nav {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .nav-header {
    padding: var(--space-2) var(--space-3);
    margin-bottom: var(--space-2);
  }

  .nav-kit-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    border-radius: var(--radius-full);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .nav-kit-badge.filled {
    background: var(--section-accent);
    color: white;
  }

  .nav-kit-badge.outlined {
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    color: var(--color-text-primary);
  }

  .nav-section {
    display: flex;
    flex-direction: column;
    margin-bottom: var(--space-2);
  }

  .nav-section-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: transparent;
    border: none;
    color: var(--color-text-secondary);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    border-radius: var(--radius-md);
    transition: all 0.15s;
    text-align: left;
    width: 100%;
  }

  .nav-section-title:hover {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
  }

  .chevron {
    transition: transform 0.2s;
    color: var(--color-text-muted);
    width: 14px;
    height: 14px;
  }

  .nav-section.collapsed .chevron {
    transform: rotate(0deg);
  }

  .nav-section:not(.collapsed) .chevron {
    transform: rotate(90deg);
  }

  .category-icon {
    color: var(--section-accent);
    width: 16px;
    height: 16px;
  }

  .folder-icon {
    color: var(--section-accent);
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .item-count {
    margin-left: auto;
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    font-weight: var(--font-normal);
  }

  .nav-items {
    display: flex;
    flex-direction: column;
    gap: 0;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .nav-items[hidden] {
    display: none;
  }

  .nav-link {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    border-radius: var(--radius-md);
    transition: all 0.15s;
    text-decoration: none;
  }

  /* Different padding for categorized layout (nested items) */
  [data-collapsible] .nav-link {
    padding-left: calc(var(--space-3) + 32px);
  }

  /* Different padding for grouped layout */
  .section-nav:has(.folder-icon) .nav-link {
    padding-left: calc(var(--space-3) + 12px);
  }

  .nav-link:hover {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    text-decoration: none;
  }

  .nav-link.active {
    background: var(--color-bg-tertiary);
    color: var(--section-accent);
    border-left: 2px solid var(--section-accent);
  }

  /* Adjust padding for active state in categorized layout */
  [data-collapsible] .nav-link.active {
    padding-left: calc(var(--space-3) + 30px);
  }

  /* Adjust padding for active state in flat/grouped layouts */
  .section-nav:not(:has([data-collapsible])) .nav-link.active {
    padding-left: calc(var(--space-3) - 2px);
  }

  .section-nav:has(.folder-icon) .nav-link.active {
    padding-left: calc(var(--space-3) + 10px);
  }

  .doc-icon {
    color: var(--color-text-muted);
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .nav-link.active .doc-icon {
    color: var(--section-accent);
  }
</style>
